---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 30-graphics-with-ggplot2.md in _episodes_rmd/
source: Rmd
title: "Graphics with ggplot2"
teaching: XX
exercises: XX
questions:
- "How can I generate plots from tabular data in R?"
objectives:
- Make scatter plots and box plots to display your data.
- Use aesthetics to change how variables map to axes, color, or size.
keypoints:
- "Although other plotting systems exist in R, ggplot2 is a good choice for beginners because it is very powerful and relatively user-friendly."
- "Different components of the plot can be added together, much like layers in a Photoshop document."
---



## Setup

### Dataset for this lesson

If you don't already have it from the previous lesson, download the dataset from
[Blackmore *et al.* (2017)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5544260/)
and read it into R:


~~~
if (!file.exists("data/rnaseq.csv"))
    download.file(url = "https://raw.githubusercontent.com/UCLouvain-CBIO/WSBIM1207/scrnadata/data/rnaseq.csv",
                  destfile = "data/rnaseq.csv")

rna <- read.csv("data/rnaseq.csv")

head(rna)
~~~
{: .language-r}



~~~
     gene     sample expression     organism age    sex  infection  strain time
1     Asl GSM2545336       1170 Mus musculus   8 Female InfluenzaA C57BL/6    8
2    Apod GSM2545336      36194 Mus musculus   8 Female InfluenzaA C57BL/6    8
3 Cyp2d22 GSM2545336       4060 Mus musculus   8 Female InfluenzaA C57BL/6    8
4    Klk6 GSM2545336        287 Mus musculus   8 Female InfluenzaA C57BL/6    8
5   Fcrls GSM2545336         85 Mus musculus   8 Female InfluenzaA C57BL/6    8
6  Slc2a4 GSM2545336        782 Mus musculus   8 Female InfluenzaA C57BL/6    8
      tissue mouse
1 Cerebellum    14
2 Cerebellum    14
3 Cerebellum    14
4 Cerebellum    14
5 Cerebellum    14
6 Cerebellum    14
~~~
{: .output}

### Install and load ggplot2

The default R installation does not include ggplot2, so you will need to install
it if you haven't already:


~~~
install.packages("ggplot2")
~~~
{: .language-r}

And then you'll load it with `library` in order to use it:


~~~
library(ggplot2)
~~~
{: .language-r}

## Getting help

The [website for ggplot2](https://ggplot2.tidyverse.org/) has a cheatsheet and
other useful documentation.  This is a very popular R package, so Google and
Stack Overflow are also very helpful for getting answers!

## Your first plots

The base R installation has the `plot` function and some other functions
for generating plots.  You can make a scatter plot or box plot pretty
quickly this way, but it might not look very nice.

> ## Data transformation
> 
> Because the gene expression data are not normally distributed, here we are
> using the `log1p` function to log transform them.  Because the log of zero
> is negative infinity, and because we have zeros in our dataset, `log1p`
> adds one before log transforming.
{: .callout}


~~~
plot(x = rna$time, y = log1p(rna$expression))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig010-1.png" title="plot of chunk ggfig010" alt="plot of chunk ggfig010" width="612" style="display: block; margin: auto;" />


~~~
plot(x = as.factor(rna$infection), y = log1p(rna$expression))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig020-1.png" title="plot of chunk ggfig020" alt="plot of chunk ggfig020" width="612" style="display: block; margin: auto;" />

I can make the same plots with ggplot2, and hopefully both the code and the
graphics will look a bit better.  (Note that although the package is called
ggplot2, the function is `ggplot`.)


~~~
ggplot(rna, aes(x = time, y = log1p(expression))) +
  geom_point()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig030-1.png" title="plot of chunk ggfig030" alt="plot of chunk ggfig030" width="612" style="display: block; margin: auto;" />


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_boxplot()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig040-1.png" title="plot of chunk ggfig040" alt="plot of chunk ggfig040" width="612" style="display: block; margin: auto;" />

## Components of a ggplot command

### Call to `ggplot`

In both of the above plots, you'll notice that the first command we used was
`ggplot`.  If you look at the help page for that function, you'll see that there
are two arguments (or, at least, two arguments that can be used): `data` and
`mapping`.  We gave the `data` argument our data frame.  What does this look like
by itself?


~~~
ggplot(rna)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig050-1.png" title="plot of chunk ggfig050" alt="plot of chunk ggfig050" width="612" style="display: block; margin: auto;" />

It basically opened an empty plot, because we gave it data but didn't say anything
about what to do with it.

To the `mapping` argument, we supplied an object that we created using the `aes`
function.  The `aes` function does not have any use outside of ggplot2, but within
ggplot2 it indicates how the variables from the data frame should be used in
the plot.  The function knows to look for variable names in the column names of
the data frame that was supplied, which is very helpful.  What do we get when
we add this in?


~~~
ggplot(rna, aes(x = infection, y = log1p(expression)))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig060-1.png" title="plot of chunk ggfig060" alt="plot of chunk ggfig060" width="612" style="display: block; margin: auto;" />

Now the axes are set up because we've said what we're putting onto them, but
we still haven't plotted anything.

### Geoms

Now we need to add one or more "geoms" to the command to plot our data.
Previously we added a box plot.  We could also do a violin plot, which is a hybrid
between a box plot and density plot.

Notice the use of the `+` sign to combine different commands.  That's pretty
different from the syntax of any other R package, but it's how we do things with
ggplot!


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig070-1.png" title="plot of chunk ggfig070" alt="plot of chunk ggfig070" width="612" style="display: block; margin: auto;" />

There can be multiple geoms in one plot.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin() +
  geom_point()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig080-1.png" title="plot of chunk ggfig080" alt="plot of chunk ggfig080" width="612" style="display: block; margin: auto;" />

> ## Challenge: Changing the geom order
>
> Try switching `geom_point` with `geom_violin` in the above command, so that
> `geom_point` is first and `geom_violin` is second.  What happens?
>
> > ## Solution
> > 
> > Most of the points are no longer visible, because they are now underneath
> > the violin plot.  Geoms are plotted in the order they appear in the command.
> >
> > 
> > ~~~
> > ggplot(rna, aes(x = infection, y = log1p(expression))) +
> >   geom_point() +
> >   geom_violin()
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-ggfig090-1.png" title="plot of chunk ggfig090" alt="plot of chunk ggfig090" width="612" style="display: block; margin: auto;" />
> {: .solution}
{: .challenge}

In these examples, we didn't provide any arguments to the geom functions.
However, they have their own `data` and `mapping` arguments if you want to
override what was provided in the `ggplot` function.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin() +
  geom_point(mapping = aes(y = log1p(expression) + 10))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig100-1.png" title="plot of chunk ggfig100" alt="plot of chunk ggfig100" width="612" style="display: block; margin: auto;" />

A quick way to see what other geoms are available is to start typing
`geom` into your R console and look at the autocomplete list.

### More aesthetics

If I look at `?geom_violin` and scroll down to the "Aesthetics" section, there
is a list of other aesthetics we can control.  Although I have treatment on the
x-axis, it might help visually to also color by treatment.  Since this only
applies to one geom, I'll only pass it to that one.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig110-1.png" title="plot of chunk ggfig110" alt="plot of chunk ggfig110" width="612" style="display: block; margin: auto;" />

To change an aesthethic value across the board, rather than have it indicate the
value of a variable, we can define it outside of the `mapping` argument.  For
example, I can set `alpha` to control point transparency.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig120-1.png" title="plot of chunk ggfig120" alt="plot of chunk ggfig120" width="612" style="display: block; margin: auto;" />

### Titles and axis labels

You might want your plot to have a title, or for the axis labels to be something
different from the variable names.  We'll use the `labs` function for that.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection")
~~~
{: .language-r}

<img src="../fig/rmd-ggfig130-1.png" title="plot of chunk ggfig130" alt="plot of chunk ggfig130" width="612" style="display: block; margin: auto;" />

### Facets

When you are working with a lot of variables, it might make sense to split the
graph into multiple plots.  We can do that with the `facet_wrap` and `facet_grid`
functions.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_wrap(~ tissue)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig140-1.png" title="plot of chunk ggfig140" alt="plot of chunk ggfig140" width="612" style="display: block; margin: auto;" />


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig150-1.png" title="plot of chunk ggfig150" alt="plot of chunk ggfig150" width="612" style="display: block; margin: auto;" />

### Scales

I log-transformed my gene expression before plotting, but maybe I'd prefer
to see it in the original units.  I can change how my y-axis is set up
with `scale_y_continuous`.  The `trans` argument says how I want to transform
the axis, and the `breaks` argument tells it where to put axis ticks and grid
lines.


~~~
ggplot(rna, aes(x = infection, y = expression)) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "Expression",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue) +
  scale_y_continuous(trans = "log1p",
                     breaks = c(0, 1e2, 1e3, 1e4, 1e5, 1e6))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig160-1.png" title="plot of chunk ggfig160" alt="plot of chunk ggfig160" width="612" style="display: block; margin: auto;" />

> ## Challenge: Changing the fill colors
>
> I'd like the violin plots to be filled with something other than the default
> salmon and teal.  Look at the help page for `scale_fill_manual` and see if
> you can figure out how to use it.  You can specify colors with simple strings
> like `"green"` and `"blue"`.
> 
> If you have extra time, you can play around with color names from
> [this list](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf).
> You can also use a [color picker](https://www.w3schools.com/colors/colors_picker.asp)
> to generate custom color strings like `#4d94ff`
>
> > ## Solution
> >
> > 
> > ~~~
> > ggplot(rna, aes(x = infection, y = expression)) +
> >  geom_violin(mapping = aes(fill = infection)) +
> >  geom_point(alpha = 0.01) +
> >  labs(x = "Treatment", fill = "Treatment", y = "Expression",
> >       title = "Gene expression vs. viral infection") +
> >  facet_grid(sex ~ tissue) +
> >  scale_y_continuous(trans = "log1p",
> >                     breaks = c(0, 1e2, 1e3, 1e4, 1e5, 1e6)) +
> >  scale_fill_manual(values = c(InfluenzaA = "darkolivegreen4",
> >                               NonInfected = "royalblue"))
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-ggfig170-1.png" title="plot of chunk ggfig170" alt="plot of chunk ggfig170" width="612" style="display: block; margin: auto;" />
> {: .solution}
{: .challenge}

### Themes

If you want to change something like grid lines or the angle of axis tick labels,
you probably want to add a `theme` command.  There are some pre-build themes, for
example:


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue) +
  theme_bw()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig180-1.png" title="plot of chunk ggfig180" alt="plot of chunk ggfig180" width="612" style="display: block; margin: auto;" />

If I just wanted to change the font:


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue) +
  theme(text = element_text(family = "serif"))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig190-1.png" title="plot of chunk ggfig190" alt="plot of chunk ggfig190" width="612" style="display: block; margin: auto;" />

Rotating axis labels:


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue) +
  theme(text = element_text(family = "serif"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
~~~
{: .language-r}

<img src="../fig/rmd-ggfig200-1.png" title="plot of chunk ggfig200" alt="plot of chunk ggfig200" width="612" style="display: block; margin: auto;" />

There are too many options here to unpack in a short lesson, but look
at `?theme` and `?element_text` for more information.

### Coordinate systems

What if I want to rotate my plot 90 degrees?  I can do that with `coord_flip`.


~~~
ggplot(rna, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue) +
  coord_flip()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig210-1.png" title="plot of chunk ggfig210" alt="plot of chunk ggfig210" width="612" style="display: block; margin: auto;" />

## Using other tidyverse packages with ggplot2

The tidyverse is a group of R packages that are designed to work together to make
data science easier for everyone.  Here are a couple examples of handy functions
to use with ggplot2.

### dplyr

Say I only wanted to look at expression of the _Swt1_ gene. I could filter the
data frame in the "base R" fashion (note that I am putting `alpha` back to the
default since I have far fewer points now):


~~~
ggplot(rna[rna$gene == "Swt1",], aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point() +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig220-1.png" title="plot of chunk ggfig220" alt="plot of chunk ggfig220" width="612" style="display: block; margin: auto;" />

The [dplyr](https://dplyr.tidyverse.org/) package has a lot of functions for
data frame manipulation, and can be used to make a slightly more readable
version of the above command.  The `filter` function is helpful if you only want
to keep certain rows.  We'll also use the pipe command `%>%` (originally from
the magrittr package) to send output of one expression as input to the next
function so we don't have to nest functions so much.


~~~
library(dplyr)
~~~
{: .language-r}



~~~

Attaching package: 'dplyr'
~~~
{: .output}



~~~
The following objects are masked from 'package:stats':

    filter, lag
~~~
{: .output}



~~~
The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union
~~~
{: .output}



~~~
rna %>%
  filter(gene == "Swt1") %>%
  ggplot(mapping = aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point() +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig230-1.png" title="plot of chunk ggfig230" alt="plot of chunk ggfig230" width="612" style="display: block; margin: auto;" />

### tidyr

The [tidyr](https://raw.githubusercontent.com/rstudio/cheatsheets/master/tidyr.pdf) R package
can help you clean up and arrange your data.  In particular, I often find myself
in a situation where I imported something as multiple columns that needs to be
a single column, or vice versa.  The `pivot_longer` and `pivot_wider` functions
are helpful in those cases.

Say I want to have a separate gene expression column for each sample.


~~~
library(tidyr)

rna_wider <- pivot_wider(rna[,c("gene", "sample", "expression")],
                         names_from = sample, values_from = expression)

head(rna_wider)
~~~
{: .language-r}



~~~
# A tibble: 6 x 46
  gene    GSM2545336 GSM2545337 GSM2545338 GSM2545339 GSM2545340 GSM2545341
  <chr>        <int>      <int>      <int>      <int>      <int>      <int>
1 Asl           1170        361        400        586        626        988
2 Apod         36194      10347       9173      10620      13021      29594
3 Cyp2d22       4060       1616       1603       1901       2171       3349
4 Klk6           287        629        641        578        448        195
5 Fcrls           85        233        244        237        180         38
6 Slc2a4         782        231        248        265        313        786
# ... with 39 more variables: GSM2545342 <int>, GSM2545343 <int>,
#   GSM2545344 <int>, GSM2545345 <int>, GSM2545346 <int>, GSM2545347 <int>,
#   GSM2545348 <int>, GSM2545349 <int>, GSM2545350 <int>, GSM2545351 <int>,
#   GSM2545352 <int>, GSM2545353 <int>, GSM2545354 <int>, GSM2545355 <int>,
#   GSM2545356 <int>, GSM2545357 <int>, GSM2545358 <int>, GSM2545359 <int>,
#   GSM2545360 <int>, GSM2545361 <int>, GSM2545362 <int>, GSM2545363 <int>,
#   GSM2545364 <int>, GSM2545365 <int>, GSM2545366 <int>, GSM2545367 <int>, ...
~~~
{: .output}

The output is a `tibble`, which is really just the tidyverse version of a data frame.
Anyway, now we can make a plot like the one below to compare each gene across two samples.


~~~
ggplot(rna_wider, aes(x = log1p(GSM2545336), y = log1p(GSM2545337))) +
  geom_point()
~~~
{: .language-r}

<img src="../fig/rmd-ggfig240-1.png" title="plot of chunk ggfig240" alt="plot of chunk ggfig240" width="612" style="display: block; margin: auto;" />

If I had started with a data frame set up like `rna_wider` and wanted it in long
format, I could do the opposite operation using `pivot_longer`.

> ## Selecting columns
>
> See `?tidyr_tidy_select` for methods to select columns in the tidyverse,
> including `starts_with`.
{: .callout}


~~~
rna_longer <- pivot_longer(rna_wider, cols = starts_with("GSM"),
                           names_to = "sample", values_to = "expression")

head(rna_longer)
~~~
{: .language-r}



~~~
# A tibble: 6 x 3
  gene  sample     expression
  <chr> <chr>           <int>
1 Asl   GSM2545336       1170
2 Asl   GSM2545337        361
3 Asl   GSM2545338        400
4 Asl   GSM2545339        586
5 Asl   GSM2545340        626
6 Asl   GSM2545341        988
~~~
{: .output}

All the sample metadata are missing from `rna_longer`, however.  I'll build a
metadata table here from the original, although you could have hypothetically
imported such metadata from a CSV.


~~~
metadata <- rna[,c("sample", "sex", "infection", "time", "tissue", "mouse")]
metadata <- metadata[!duplicated(metadata),]
head(metadata)
~~~
{: .language-r}



~~~
         sample    sex   infection time     tissue mouse
1    GSM2545336 Female  InfluenzaA    8 Cerebellum    14
1478 GSM2545337 Female NonInfected    0 Cerebellum     9
2955 GSM2545338 Female NonInfected    0 Cerebellum    10
4432 GSM2545339 Female  InfluenzaA    4 Cerebellum    15
5909 GSM2545340   Male  InfluenzaA    4 Cerebellum    18
7386 GSM2545341   Male  InfluenzaA    8 Cerebellum     6
~~~
{: .output}

We could then use `left_join` from the `dplyr` package to recreate the original
dataset.


~~~
rna_orig <- left_join(rna_longer, metadata, by = "sample")
head(rna_orig)
~~~
{: .language-r}



~~~
# A tibble: 6 x 8
  gene  sample     expression sex    infection    time tissue     mouse
  <chr> <chr>           <int> <chr>  <chr>       <int> <chr>      <int>
1 Asl   GSM2545336       1170 Female InfluenzaA      8 Cerebellum    14
2 Asl   GSM2545337        361 Female NonInfected     0 Cerebellum     9
3 Asl   GSM2545338        400 Female NonInfected     0 Cerebellum    10
4 Asl   GSM2545339        586 Female InfluenzaA      4 Cerebellum    15
5 Asl   GSM2545340        626 Male   InfluenzaA      4 Cerebellum    18
6 Asl   GSM2545341        988 Male   InfluenzaA      8 Cerebellum     6
~~~
{: .output}



~~~
ggplot(rna_orig, aes(x = infection, y = log1p(expression))) +
  geom_violin(mapping = aes(fill = infection)) +
  geom_point(alpha = 0.01) +
  labs(x = "Treatment", fill = "Treatment", y = "logCPM",
       title = "Gene expression vs. viral infection") +
  facet_grid(sex ~ tissue)
~~~
{: .language-r}

<img src="../fig/rmd-ggfig250-1.png" title="plot of chunk ggfig250" alt="plot of chunk ggfig250" width="612" style="display: block; margin: auto;" />

